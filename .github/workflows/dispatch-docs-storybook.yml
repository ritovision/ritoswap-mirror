name: Dispatch Docs & Storybook

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  dispatch-and-wait:
    if: github.repository == 'ritovision/ritoswap-mirror'
    runs-on: ubuntu-latest
    timeout-minutes: 70
    environment: ci-dispatch
    steps:
      - name: Dispatch private workflow
        id: dispatch
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.RITOSWAP_PAT }}
          script: |
            const owner = 'ritovision';
            const repo = 'ritoswap';
            const workflow_id = 'pipeline-docs-storybook.yml';
            const ref = 'main';
            const triggerId = '${{ github.run_id }}';

            await github.rest.actions.createWorkflowDispatch({
              owner,
              repo,
              workflow_id,
              ref,
              inputs: {
                trigger_id: triggerId,
              },
            });

            core.setOutput('trigger_id', triggerId);

      - name: Wait for completion
        uses: actions/github-script@v7
        env:
          TRIGGER_ID: ${{ steps.dispatch.outputs.trigger_id }}
        with:
          github-token: ${{ secrets.RITOSWAP_PAT }}
          script: |
            const owner = 'ritovision';
            const repo = 'ritoswap';
            const workflow_id = 'pipeline-docs-storybook.yml';
            const triggerId = process.env.TRIGGER_ID;
            const deadline = Date.now() + 60 * 60 * 1000;
            const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

            let run;
            while (Date.now() < deadline) {
              const { data } = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id,
                event: 'workflow_dispatch',
                branch: 'main',
                per_page: 10,
              });

              run = data.workflow_runs.find((r) => {
                const title = r.display_title || '';
                return title.includes(`mirror ${triggerId}`);
              });

              if (run) break;
              await sleep(15000);
            }

            if (!run) {
              core.setFailed('No matching dispatched run found');
              return;
            }

            while (Date.now() < deadline) {
              const { data } = await github.rest.actions.getWorkflowRun({
                owner,
                repo,
                run_id: run.id,
              });

              if (data.status === 'completed') {
                if (data.conclusion !== 'success') {
                  core.setFailed(`Remote pipeline ${data.conclusion}`);
                }
                return;
              }

              await sleep(15000);
            }

            core.setFailed('Timed out waiting for remote pipeline');
