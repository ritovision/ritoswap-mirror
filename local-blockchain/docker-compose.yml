
services:
  besu:
    build:
      context: ./docker/besu
      args:
        BESU_VERSION: ${BESU_VERSION:-25.11.0}
    container_name: ritoswap-besu
    command: >
      --data-path=/data
      --genesis-file=/config/genesis.json
      --rpc-http-enabled
      --rpc-http-host=0.0.0.0
      --rpc-http-port=${RPC_PORT:-8545}
      --rpc-http-api=ETH,NET,WEB3,DEBUG,TRACE,TXPOOL
      --rpc-ws-enabled
      --rpc-ws-host=0.0.0.0
      --rpc-ws-port=${RPC_WS_PORT:-8546}
      --rpc-ws-api=ETH,NET,WEB3,DEBUG,TRACE,TXPOOL
      --host-allowlist=*
      --rpc-http-cors-origins=*
      --p2p-port=${P2P_PORT:-30303}
      --p2p-host=0.0.0.0
      --discovery-enabled=false
      --min-gas-price=0
      --sync-mode=FULL
      --data-storage-format=FOREST
      --node-private-key-file=/config/keys/validator.key
      --logging=INFO
      --rpc-http-max-active-connections=500
      --rpc-http-max-batch-size=1000
      --tx-pool=sequenced
      --tx-pool-max-size=20000
      --tx-pool-limit-by-account-percentage=1.0
    volumes:
      - ./data/besu:/data
      - ./config:/config:ro
    ports:
      - "${RPC_PORT:-8545}:8545"
      - "${RPC_WS_PORT:-8546}:8546"
      - "${P2P_PORT:-30303}:30303"
    environment:
      - LOCAL_CHAIN_ID=${LOCAL_CHAIN_ID:-1337}
      - BLOCK_TIME=${BLOCK_TIME:-5}
    networks:
      - ritoswap

  redis-db:
    extends:
      file: ./blockscout/docker-compose/services/redis.yml
      service: redis-db
    networks:
      - ritoswap

  db-init:
    extends:
      file: ./blockscout/docker-compose/services/db.yml
      service: db-init
    networks:
      - ritoswap

  db:
    depends_on:
      db-init:
        condition: service_completed_successfully
    extends:
      file: ./blockscout/docker-compose/services/db.yml
      service: db
    networks:
      - ritoswap

  backend:
    depends_on:
      - db
      - redis-db
      - besu
    extends:
      file: ./blockscout/docker-compose/services/backend.yml
      service: backend
    build:
      context: ./blockscout
      dockerfile: ./docker/Dockerfile
      args:
        RELEASE_VERSION: ${BLOCKSCOUT_TAG:-v9.2.2}
    links:
      - db:database
    environment:
      - ETHEREUM_JSONRPC_HTTP_URL=http://besu:8545
      - ETHEREUM_JSONRPC_TRACE_URL=http://besu:8545
      - ETHEREUM_JSONRPC_WS_URL=ws://besu:8546
      - CHAIN_ID=${LOCAL_CHAIN_ID:-1337}
      - NETWORK=${NETWORK_NAME:-RitoSwap Localnet}
      - SUBNETWORK=${SUBNETWORK:-Local}
      - COIN=${COIN_NAME:-RITO}
      - COIN_SYMBOL=${COIN_SYMBOL:-RITO}
    networks:
      - ritoswap

  nft_media_handler:
    depends_on:
      - backend
    extends:
      file: ./blockscout/docker-compose/services/nft_media_handler.yml
      service: nft_media_handler
    build:
      context: ./blockscout
      dockerfile: ./docker/Dockerfile
      args:
        RELEASE_VERSION: ${BLOCKSCOUT_TAG:-v9.2.2}
    networks:
      - ritoswap

  visualizer:
    extends:
      file: ./blockscout/docker-compose/services/visualizer.yml
      service: visualizer
    networks:
      - ritoswap

  sig-provider:
    extends:
      file: ./blockscout/docker-compose/services/sig-provider.yml
      service: sig-provider
    networks:
      - ritoswap

  frontend:
    depends_on:
      - backend
    extends:
      file: ./blockscout/docker-compose/services/frontend.yml
      service: frontend
    environment:
      NEXT_PUBLIC_API_HOST: ${BLOCKSCOUT_PUBLIC_HOST:-localhost}
      NEXT_PUBLIC_APP_HOST: ${BLOCKSCOUT_PUBLIC_HOST:-localhost}
      NEXT_PUBLIC_STATS_API_HOST: http://${BLOCKSCOUT_PUBLIC_HOST:-localhost}:8080
      NEXT_PUBLIC_VISUALIZE_API_HOST: http://${BLOCKSCOUT_PUBLIC_HOST:-localhost}:8081
    networks:
      - ritoswap

  stats-db-init:
    extends:
      file: ./blockscout/docker-compose/services/stats.yml
      service: stats-db-init
    networks:
      - ritoswap

  stats-db:
    depends_on:
      stats-db-init:
        condition: service_completed_successfully
    extends:
      file: ./blockscout/docker-compose/services/stats.yml
      service: stats-db
    networks:
      - ritoswap

  stats:
    depends_on:
      - stats-db
      - backend
    extends:
      file: ./blockscout/docker-compose/services/stats.yml
      service: stats
    networks:
      - ritoswap

  user-ops-indexer:
    depends_on:
      - db
      - backend
    extends:
      file: ./blockscout/docker-compose/services/user-ops-indexer.yml
      service: user-ops-indexer
    networks:
      - ritoswap

  proxy:
    depends_on:
      - backend
      - frontend
      - stats
    extends:
      file: ./blockscout/docker-compose/services/nginx.yml
      service: proxy
    ports:
      - "${BLOCKSCOUT_PORT:-4001}:80"
    networks:
      - ritoswap

networks:
  ritoswap:
    driver: bridge

volumes:
  blockscout-db-data:
  redis-data:
  stats-db-data:
